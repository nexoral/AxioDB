name: Push to Registry

on:
  push:
    branches:
      - main


permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Run GUI Build
        run: cd GUI && npm install && npm run build && cd ..
      - name: Move GUI build files
        run: cd ./GUI && mv AxioControl/ ../lib/server/public && cd ..
      - name: Run tests
        run: npm run test

  publish_to_npm:
    needs: [test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: npm ci
      - name: Build package
        run: npm run build
      - name: Run GUI Build
        run: cd GUI && npm install && npm run build && cd ..
      - name: Move GUI build files
        run: cd ./GUI && mv AxioControl/ ../lib/server/public && cd ..
      - name: Set NPM Auth Token
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_AUTH_TOKEN }}" > ~/.npmrc
      - name: Publish to NPM Registry
        run: npm publish --access public

  publish_to_github:
    needs: [test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: npm install
      - name: Build package
        run: npm run build
      - name: Run GUI Build
        run: cd GUI && npm install && npm run build && cd ..
      - name: Move GUI build files
        run: cd ./GUI && mv AxioControl/ ../lib/server/public && cd ..
      - name: Set GitHub Auth Token
        run: echo "//npm.pkg.github.com/:_authToken=${{ secrets.GIT_AUTH_TOKEN }}" >> ~/.npmrc
      - name: Change package name in package.json
        run: |
          sudo apt-get update && sudo apt-get install -y sed
          sed -i '2s/"axiodb"/"@${{ secrets.GIT_USER_NAME }}\/axiodb"/' package.json
      - name: Publish to GitHub Package Registry
        run: npm publish --registry=https://npm.pkg.github.com --scope=@${{ secrets.GIT_USER_NAME }} --access public

  publish_to_dockerhub:
    needs: [publish_to_npm]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: npm install

    - name: Build package
      run: npm run build

    - name: Run GUI Build
      run: cd GUI && npm install && npm run build && cd ..

    - name: Move GUI build files
      run: cd ./GUI && mv AxioControl/ ../lib/server/public && cd ..

    - name: Move the lib folder to Docker context
      run: mv lib/ Docker/

    - name: Copy package.json files
      run: cp package*.json Docker/

    # ðŸ”‘ Login to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/axiodb:latest Docker/

    - name: Push Docker image
      run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/axiodb:latest
